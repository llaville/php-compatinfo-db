#!/usr/bin/env php
<?php declare(strict_types=1);
/**
 * This file is part of the PHP_CompatInfoDB package.
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 *
 * @author Laurent Laville
 */

// @link https://www.tomasvotruba.cz/blog/2018/08/02/5-gotchas-of-the-bin-file-in-php-cli-applications/

gc_disable(); // performance boost

require_once dirname(__DIR__) . '/config/bootstrap.php';

use Bartlett\CompatInfoDb\Application\Configuration\ContainerFactory;
use Bartlett\CompatInfoDb\Presentation\Console\ApplicationInterface;
use Bartlett\CompatInfoDb\Presentation\Console\Command\AbstractCommand;
use Bartlett\CompatInfoDb\Presentation\Console\Style;

use Symfony\Component\Console\CommandLoader\CommandLoaderInterface;
use Symfony\Component\Console\Input\ArgvInput;
use Symfony\Component\Console\Output\ConsoleOutput;

$input = new ArgvInput();

try {
    $container = (new ContainerFactory())->createFromInput($input);
    $app = $container->get(ApplicationInterface::class);
    $app->setContainer($container);
} catch (Throwable $e) {
    $output = new ConsoleOutput();
    $io = new Style($input, $output);
    $io->error($e->getMessage());
    exit(AbstractCommand::FAILURE);
}

// @link https://symfony.com/doc/current/console/lazy_commands.html
$app->setCommandLoader($container->get(CommandLoaderInterface::class));

exit($app->run());
